---
title: "NodeLoc Payment Plugin API å¯¹æ¥æ–‡æ¡£"
description: "è¯¦ç»†ä»‹ç»å¦‚ä½•å°†ä½ çš„ç½‘ç«™ä¸ NodeLoc Payment Plugin é›†æˆï¼Œå®ç°èƒ½é‡æ”¯ä»˜åŠŸèƒ½"
version: "1.0.1"
lastUpdated: "Wed Oct 08 2025 08:00:00 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)"
---

import { Callout } from '@/components/Callout'
import { CodeBlock } from '@/components/CodeBlock'
import { Tabs, Tab } from '@/components/Tabs'
import { Steps } from '@/components/Steps'

# NodeLoc Payment Plugin API å¯¹æ¥æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•å°†ä½ çš„ç½‘ç«™ä¸ NodeLoc Payment Plugin é›†æˆï¼Œå®ç°èƒ½é‡æ”¯ä»˜åŠŸèƒ½ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å‰ç½®å‡†å¤‡](#å‰ç½®å‡†å¤‡)
- [è®¤è¯æœºåˆ¶](#è®¤è¯æœºåˆ¶)
- [API æ¥å£](#api-æ¥å£)
- [é›†æˆæµç¨‹](#é›†æˆæµç¨‹)
- [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [å®‰å…¨å»ºè®®](#å®‰å…¨å»ºè®®)

## æ¦‚è¿°

NodeLoc Payment Plugin æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„æ”¯ä»˜æ¥å£ï¼Œå…è®¸å¤–éƒ¨ç½‘ç«™ä½¿ç”¨ NodeLoc ç”¨æˆ·çš„èƒ½é‡è¿›è¡Œæ”¯ä»˜ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

<dl>
  <dt><strong>Payment Applicationï¼ˆæ”¯ä»˜åº”ç”¨ï¼‰</strong></dt>
  <dd>ä½ åœ¨ NodeLoc ä¸Šæ³¨å†Œçš„åº”ç”¨ï¼Œç”¨äºæ ‡è¯†ä½ çš„ç½‘ç«™</dd>

  <dt><strong>Payment ID</strong></dt>
  <dd>åº”ç”¨çš„å”¯ä¸€æ ‡è¯†ç¬¦</dd>

  <dt><strong>Token</strong></dt>
  <dd>åº”ç”¨çš„å¯†é’¥ï¼Œç”¨äºç”Ÿæˆç­¾å</dd>

  <dt><strong>Signatureï¼ˆç­¾åï¼‰</strong></dt>
  <dd>ç”¨äºéªŒè¯è¯·æ±‚çœŸå®æ€§çš„å“ˆå¸Œå€¼</dd>
</dl>

### æ”¯ä»˜æµç¨‹

```mermaid
graph LR
    A[ä½ çš„ç½‘ç«™] --> B[åˆ›å»ºæ”¯ä»˜è¯·æ±‚]
    B --> C[NodeLoc æ”¯ä»˜é¡µé¢]
    C --> D[ç”¨æˆ·ç¡®è®¤]
    D --> E[æ‰£é™¤èƒ½é‡]
    E --> F[å›è°ƒé€šçŸ¥]
    F --> G[ä½ çš„ç½‘ç«™]
```

<info>
  ğŸ’¡ **æç¤º**: æ•´ä¸ªæ”¯ä»˜æµç¨‹é‡‡ç”¨ HMAC-SHA256 ç­¾åæœºåˆ¶ï¼Œç¡®ä¿äº¤æ˜“å®‰å…¨å¯é ã€‚
</info>

## å‰ç½®å‡†å¤‡

<Steps>
  ### åˆ›å»ºæ”¯ä»˜åº”ç”¨

  1. è®¿é—® NodeLoc ç«™ç‚¹çš„ `/payment/applications` é¡µé¢
  2. ç‚¹å‡»"æ–°å»ºæ”¯ä»˜åº”ç”¨"
  3. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š
     - **åº”ç”¨åç§°**: ä½ çš„ç½‘ç«™åç§°
     - **ç½‘ç«™ URL**: ä½ çš„ç½‘ç«™åœ°å€
     - **å›è°ƒ URL**: æ¥æ”¶æ”¯ä»˜ç»“æœçš„å›è°ƒåœ°å€
     - **æè¿°**: åº”ç”¨è¯´æ˜ï¼ˆå¯é€‰ï¼‰
  4. æäº¤åä¼šç”Ÿæˆï¼š
     - **Payment ID**: å¦‚ `pay_a1b2c3d4e5f6...`
     - **Token**: å¦‚ `tk_a1b2c3d4e5f6...`ï¼ˆä»…æ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·åŠ¡å¿…ä¿å­˜ï¼‰
  5. ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹ï¼Œå®¡æ‰¹é€šè¿‡åå³å¯ä½¿ç”¨

  ### ä¿å­˜å‡­è¯

  å°† Payment ID å’Œ Token ä¿å­˜åˆ°ä½ çš„æœåŠ¡å™¨é…ç½®ä¸­ï¼Œä¾‹å¦‚ï¼š

  ```bash .env
  # .env æ–‡ä»¶
  NODELOC_PAYMENT_ID=pay_a1b2c3d4e5f6...
  NODELOC_TOKEN=tk_a1b2c3d4e5f6...
  NODELOC_URL=https://www.nodeloc.com
  ```

  <warning>
    âš ï¸ **å®‰å…¨æé†’**: Token æ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œåˆ‡å‹¿æ³„éœ²æˆ–æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
  </warning>
</Steps>

## è®¤è¯æœºåˆ¶

æ‰€æœ‰æ”¯ä»˜è¯·æ±‚éƒ½éœ€è¦ä½¿ç”¨ç­¾åè¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿è¯·æ±‚æ¥è‡ªæˆæƒçš„åº”ç”¨ã€‚

### ç­¾åç”Ÿæˆç®—æ³•

<success>
  ğŸ”’ **é‡è¦å˜æ›´ (v1.0.1)**: ç­¾åç®—æ³•å·²ä» SHA256 æ”¹ä¸º **HMAC-SHA256**ï¼Œæä¾›æ›´å¼ºçš„å®‰å…¨æ€§ã€‚
</success>

ç­¾åç”Ÿæˆæ­¥éª¤ï¼š

1. å¯¹è¯·æ±‚å‚æ•°æŒ‰é”®åå­—æ¯é¡ºåºæ’åº
2. å°†å‚æ•°æ‹¼æ¥æˆ `key=value` æ ¼å¼ï¼Œç”¨ `&` è¿æ¥
3. ä½¿ç”¨ Token Hash ä½œä¸ºå¯†é’¥ï¼Œå¯¹å‚æ•°å­—ç¬¦ä¸²è¿›è¡Œ HMAC-SHA256 åŠ å¯†
4. å¾—åˆ°çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²å³ä¸ºç­¾å

### Token Hash ç”Ÿæˆ

é¦–æ¬¡è·å¾— Token åï¼Œéœ€è¦å…ˆè®¡ç®—å…¶ SHA256 å“ˆå¸Œå€¼ï¼š

<Tabs>
  <Tab title="Tab">
    ```javascript
    const crypto = require('crypto');
    const tokenHash = crypto.createHash('sha256').update(token).digest('hex');
    ```
  </Tab>
  <Tab title="Tab">
    ```php
    $tokenHash = hash('sha256', $token);
    ```
  </Tab>
  <Tab title="Tab">
    ```python
    import hashlib
    token_hash = hashlib.sha256(token.encode()).hexdigest()
    ```
  </Tab>
</Tabs>

<info>
  **é‡è¦**: ä¿å­˜ Token å’Œ Token Hashï¼Œåç»­ç­¾åä½¿ç”¨ Token Hashã€‚
</info>

### ç­¾åç¤ºä¾‹

å‡è®¾è¯·æ±‚å‚æ•°ä¸ºï¼š

```json
{
  "amount": 100,
  "description": "è´­ä¹°å•†å“",
  "order_id": "ORDER123",
  "user_id": 5
}
```

- Token: `tk_secret`
- Token Hash: `9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08`

ç”Ÿæˆç­¾åæ­¥éª¤ï¼š

```
1. æ’åº: amount, description, order_id, user_id
2. æ‹¼æ¥: amount=100&description=è´­ä¹°å•†å“&order_id=ORDER123&user_id=5
3. HMAC-SHA256: ä½¿ç”¨ Token Hash ä½œä¸ºå¯†é’¥åŠ å¯†å‚æ•°å­—ç¬¦ä¸²
4. ç»“æœ: å¾—åˆ°ç­¾åçš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²
```

### ä»£ç å®ç°

<Tabs>
  <Tab title="Tab">
    ```javascript
    const crypto = require('crypto');
    
    function generateSignature(tokenHash, params) {
      // 1. æŒ‰é”®åæ’åº
      const sortedKeys = Object.keys(params).sort();
      
      // 2. æ‹¼æ¥å‚æ•°
      const paramString = sortedKeys
        .map(key => `${key}=${params[key]}`)
        .join('&');
      
      // 3. HMAC-SHA256 åŠ å¯†
      return crypto
        .createHmac('sha256', tokenHash)
        .update(paramString)
        .digest('hex');
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    const token = 'tk_secret';
    const tokenHash = crypto.createHash('sha256').update(token).digest('hex');
    const params = {
      amount: 100,
      description: 'è´­ä¹°å•†å“',
      order_id: 'ORDER123',
      user_id: 5
    };
    
    const signature = generateSignature(tokenHash, params);
    ```
  </Tab>
  <Tab title="Tab">
    ```php
    function generateSignature($tokenHash, $params) {
        // æŒ‰é”®åæ’åº
        ksort($params);
        
        // æ‹¼æ¥å‚æ•°
        $pairs = [];
        foreach ($params as $key => $value) {
            $pairs[] = $key . '=' . $value;
        }
        $paramString = implode('&', $pairs);
        
        // HMAC-SHA256 åŠ å¯†
        return hash_hmac('sha256', $paramString, $tokenHash);
    }
    ```
  </Tab>
  <Tab title="Tab">
    ```python
    import hashlib
    import hmac
    
    def generate_signature(token_hash, params):
        # æŒ‰é”®åæ’åº
        sorted_params = sorted(params.items())
        
        # æ‹¼æ¥å‚æ•°
        param_string = '&'.join([f'{k}={v}' for k, v in sorted_params])
        
        # HMAC-SHA256 åŠ å¯†
        return hmac.new(
            token_hash.encode(),
            param_string.encode(),
            hashlib.sha256
        ).hexdigest()
    ```
  </Tab>
</Tabs>

## API æ¥å£

### 1. åˆ›å»ºæ”¯ä»˜

åˆ›å»ºä¸€ä¸ªæ”¯ä»˜è¯·æ±‚ï¼Œè¿”å›æ”¯ä»˜é¡µé¢ URLã€‚

<div className="api-endpoint">
<span className="method post">
POST</span>

 <code>
/payment/pay/'{payment_id}'/process</code>

</div>

#### è¯·æ±‚å‚æ•°

| å‚æ•°            | ç±»å‹      | å¿…å¡« | è¯´æ˜                       |
| ------------- | ------- | --- | ------------------------ |
| `amount`      | Integer | âœ…  | æ”¯ä»˜é‡‘é¢ï¼ˆèƒ½é‡æ•°é‡ï¼‰ï¼Œå¿…é¡»å¤§äº 0        |
| `description` | String  | âœ…  | æ”¯ä»˜æè¿°ï¼Œæœ€é•¿ 500 å­—ç¬¦           |
| `order_id`    | String  | âœ…  | ä½ çš„ç³»ç»Ÿè®¢å•å·ï¼Œç”¨äºå…³è”è®¢å•ï¼Œæœ€é•¿ 100 å­—ç¬¦ |
| `user_id`     | Integer | âœ…  | NodeLoc ç”¨æˆ· ID            |
| `signature`   | String  | âœ…  | è¯·æ±‚ç­¾å                     |

#### è¯·æ±‚ç¤ºä¾‹

```bash åˆ›å»ºæ”¯ä»˜è¯·æ±‚
curl -X POST https://www.nodeloc.com/payment/pay/pay_a1b2c3d4/process \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 100,
    "description": "è´­ä¹°VIPä¼šå‘˜",
    "order_id": "ORDER_20250108_001",
    "user_id": 5,
    "signature": "abc123..."
  }'
```

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "payment_url": "https://www.nodeloc.com/payment/pay/txn_a1b2c3d4",
  "transaction_id": "txn_a1b2c3d4",
  "status": "pending",
  "amount": 100,
  "user_id": 5
}
```

#### é”™è¯¯å“åº”

```json
{
  "error": "Invalid signature",
  "message": "ç­¾åéªŒè¯å¤±è´¥"
}
```

### 2. æŸ¥çœ‹æ”¯ä»˜è¯¦æƒ…

è·å–æ”¯ä»˜äº¤æ˜“çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œç”¨äºæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ï¼‰ã€‚

<div className="api-endpoint">
<span className="method get">
GET</span>

 <code>
/payment/pay/'{transaction_id}'</code>

</div>

#### è¯·æ±‚ç¤ºä¾‹

```bash
curl https://www.nodeloc.com/payment/pay/txn_a1b2c3d4
```

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "transaction_id": "txn_a1b2c3d4",
  "payment_id": "pay_a1b2c3d4",
  "amount": 100,
  "description": "è´­ä¹°VIPä¼šå‘˜",
  "order_id": "ORDER_20250108_001",
  "status": "completed",
  "user_id": 5,
  "created_at": "2025-01-08T10:30:00Z",
  "completed_at": "2025-01-08T10:32:00Z"
}
```

### 3. æ”¯ä»˜å›è°ƒ

ç”¨æˆ·å®Œæˆæ”¯ä»˜åï¼Œç³»ç»Ÿä¼šå‘ä½ çš„å›è°ƒ URL å‘é€ POST è¯·æ±‚ã€‚

<div className="api-endpoint">
<span className="method post">
POST</span>

 <code>
ä½ çš„å›è°ƒ URL</code>

</div>

#### å›è°ƒå‚æ•°

| å‚æ•°               | ç±»å‹      | è¯´æ˜                                  |
| ---------------- | ------- | ----------------------------------- |
| `transaction_id` | String  | äº¤æ˜“ID                                |
| `order_id`       | String  | ä½ çš„è®¢å•å·                               |
| `amount`         | Integer | æ”¯ä»˜é‡‘é¢                                |
| `status`         | String  | æ”¯ä»˜çŠ¶æ€: `completed`ï¼ˆæˆåŠŸï¼‰æˆ– `failed`ï¼ˆå¤±è´¥ï¼‰ |
| `user_id`        | Integer | ç”¨æˆ·ID                                |
| `payment_id`     | String  | åº”ç”¨ID                                |
| `signature`      | String  | å›è°ƒç­¾å                                |

#### å›è°ƒç¤ºä¾‹

```json
{
  "transaction_id": "txn_a1b2c3d4",
  "order_id": "ORDER_20250108_001",
  "amount": 100,
  "status": "completed",
  "user_id": 5,
  "payment_id": "pay_a1b2c3d4",
  "signature": "xyz789..."
}
```

<warning>
  **éªŒè¯å›è°ƒç­¾å**: å›è°ƒç­¾åçš„ç”Ÿæˆæ–¹å¼ä¸è¯·æ±‚ç­¾åç›¸åŒï¼Œä½ éœ€è¦éªŒè¯ç­¾åç¡®ä¿å›è°ƒæ¥è‡ª NodeLocã€‚
</warning>

#### ä½ çš„å“åº”

æˆåŠŸæ¥æ”¶å›è°ƒåï¼Œè¿”å› 200 çŠ¶æ€ç ï¼š

```json
{
  "success": true
}
```

## é›†æˆæµç¨‹

### å®Œæ•´æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Your as ä½ çš„ç½‘ç«™
    participant NL as NodeLoc
    
    User->>Your: 1. ä¸‹å•
    Your->>Your: 2. ç”Ÿæˆè®¢å•
    Your->>NL: 3. åˆ›å»ºæ”¯ä»˜è¯·æ±‚ (å¸¦ç­¾å)
    NL-->>Your: 4. è¿”å› payment_url
    Your->>User: 5. é‡å®šå‘åˆ°æ”¯ä»˜é¡µé¢
    User->>NL: 6. ç¡®è®¤æ”¯ä»˜
    NL->>NL: 7. æ‰£é™¤èƒ½é‡
    NL->>Your: 8. å›è°ƒé€šçŸ¥ (å¸¦ç­¾å)
    Your->>Your: 9. éªŒè¯ç­¾å
    Your->>Your: 10. æ›´æ–°è®¢å•
    Your-->>NL: 11. è¿”å›æˆåŠŸ
    Your->>User: 12. æä¾›æœåŠ¡
```

### å…³é”®æ­¥éª¤è¯´æ˜

<Steps>
  ### åˆ›å»ºè®¢å•

  åœ¨ä½ çš„æ•°æ®åº“ä¸­åˆ›å»ºè®¢å•è®°å½•

  ### ç”Ÿæˆç­¾å

  ä½¿ç”¨è®¢å•ä¿¡æ¯å’Œ Token ç”Ÿæˆç­¾å

  ### åˆ›å»ºæ”¯ä»˜

  è°ƒç”¨ NodeLoc API è·å–æ”¯ä»˜é“¾æ¥

  ### é‡å®šå‘ç”¨æˆ·

  å°†ç”¨æˆ·é‡å®šå‘åˆ°æ”¯ä»˜é¡µé¢

  ### å¤„ç†å›è°ƒ

  éªŒè¯å›è°ƒç­¾åå¹¶æ›´æ–°è®¢å•çŠ¶æ€
</Steps>

## ä»£ç ç¤ºä¾‹

### PHP å®Œæ•´ç¤ºä¾‹

```php DiscoursePayment.php
<?php

class NodeLocPayment {
    private $paymentId;
    private $token;
    private $tokenHash;
    private $nodelocUrl;

    public function __construct($paymentId, $token, $nodelocUrl) {
        $this->paymentId = $paymentId;
        $this->token = $token;
        $this->tokenHash = hash('sha256', $token);
        $this->nodelocUrl = rtrim($nodelocUrl, '/');
    }

    /**
     * ç”Ÿæˆ HMAC-SHA256 ç­¾å
     */
    private function generateSignature($params) {
        // æŒ‰é”®åæ’åº
        ksort($params);

        // æ‹¼æ¥å‚æ•°
        $pairs = [];
        foreach ($params as $key => $value) {
            $pairs[] = $key . '=' . $value;
        }
        $paramString = implode('&', $pairs);

        // ä½¿ç”¨ Token Hash è¿›è¡Œ HMAC-SHA256 åŠ å¯†
        return hash_hmac('sha256', $paramString, $this->tokenHash);
    }

    /**
     * åˆ›å»ºæ”¯ä»˜
     */
    public function createPayment($userId, $amount, $description, $orderId) {
        $params = [
            'amount' => $amount,
            'description' => $description,
            'order_id' => $orderId,
            'user_id' => $userId,
        ];

        $signature = $this->generateSignature($params);
        $params['signature'] = $signature;

        $url = $this->nodelocUrl . '/payment/pay/' . $this->paymentId . '/process';

        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($params));
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
            'Content-Type: application/json',
        ]);

        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        if ($httpCode === 200) {
            return json_decode($response, true);
        } else {
            throw new Exception('Payment creation failed: ' . $response);
        }
    }

    /**
     * éªŒè¯å›è°ƒç­¾å
     */
    public function verifyCallback($data) {
        $signature = $data['signature'];
        unset($data['signature']);

        $expectedSignature = $this->generateSignature($data);
        return hash_equals($expectedSignature, $signature);
    }
}

// ä½¿ç”¨ç¤ºä¾‹

// 1. åˆ›å»ºæ”¯ä»˜
$payment = new NodeLocPayment(
    'pay_a1b2c3d4',
    'tk_secret',  // åŸå§‹ Token
    'https://www.nodeloc.com'
);

try {
    $result = $payment->createPayment(
        userId: 5,
        amount: 100,
        description: 'è´­ä¹°VIPä¼šå‘˜',
        orderId: 'ORDER_' . time()
    );

    // é‡å®šå‘ç”¨æˆ·åˆ°æ”¯ä»˜é¡µé¢
    header('Location: ' . $result['payment_url']);
    exit;
} catch (Exception $e) {
    echo 'Error: ' . $e->getMessage();
}

// 2. å¤„ç†å›è°ƒï¼ˆåœ¨ callback_url å¯¹åº”çš„å¤„ç†è„šæœ¬ä¸­ï¼‰
$callbackData = json_decode(file_get_contents('php://input'), true);

if ($payment->verifyCallback($callbackData)) {
    // ç­¾åéªŒè¯æˆåŠŸ
    if ($callbackData['status'] === 'completed') {
        // æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°è®¢å•çŠ¶æ€
        // updateOrder($callbackData['order_id'], 'paid');
        echo json_encode(['success' => true]);
    } else {
        // æ”¯ä»˜å¤±è´¥
        // updateOrder($callbackData['order_id'], 'failed');
        echo json_encode(['success' => true]);
    }
} else {
    // ç­¾åéªŒè¯å¤±è´¥
    http_response_code(400);
    echo json_encode(['error' => 'Invalid signature']);
}
```

### Python å®Œæ•´ç¤ºä¾‹

```python nodeloc_payment.py
import hashlib
import hmac
import requests
import json

class NodeLocPayment:
    def __init__(self, payment_id, token, nodeloc_url):
        self.payment_id = payment_id
        self.token = token
        # è®¡ç®— Token Hash
        self.token_hash = hashlib.sha256(token.encode()).hexdigest()
        self.nodeloc_url = nodeloc_url.rstrip('/')

    def generate_signature(self, params):
        """ç”Ÿæˆ HMAC-SHA256 ç­¾å"""
        # æŒ‰é”®åæ’åº
        sorted_params = sorted(params.items())

        # æ‹¼æ¥å‚æ•°
        param_string = '&'.join([f'{k}={v}' for k, v in sorted_params])

        # HMAC-SHA256 åŠ å¯†
        return hmac.new(
            self.token_hash.encode(),
            param_string.encode(),
            hashlib.sha256
        ).hexdigest()

    def create_payment(self, user_id, amount, description, order_id):
        """åˆ›å»ºæ”¯ä»˜"""
        params = {
            'amount': amount,
            'description': description,
            'order_id': order_id,
            'user_id': user_id,
        }

        signature = self.generate_signature(params)
        params['signature'] = signature

        url = f'{self.nodeloc_url}/payment/pay/{self.payment_id}/process'

        response = requests.post(url, json=params)
        response.raise_for_status()

        return response.json()

    def verify_callback(self, data):
        """éªŒè¯å›è°ƒç­¾å"""
        signature = data.pop('signature')
        expected_signature = self.generate_signature(data)
        return signature == expected_signature

# ä½¿ç”¨ç¤ºä¾‹
import time

payment = NodeLocPayment(
    payment_id='pay_a1b2c3d4',
    token='tk_secret',  # åŸå§‹ Token
    nodeloc_url='https://www.nodeloc.com'
)

# åˆ›å»ºæ”¯ä»˜
try:
    result = payment.create_payment(
        user_id=5,
        amount=100,
        description='è´­ä¹°VIPä¼šå‘˜',
        order_id=f'ORDER_{int(time.time())}'
    )

    print(f"æ”¯ä»˜é“¾æ¥: {result['payment_url']}")
    # é‡å®šå‘ç”¨æˆ·åˆ° result['payment_url']
except Exception as e:
    print(f"é”™è¯¯: {e}")
```

### Node.js å®Œæ•´ç¤ºä¾‹

```javascript nodeloc-payment.js
const crypto = require('crypto');
const axios = require('axios');

class NodeLocPayment {
    constructor(paymentId, token, nodelocUrl) {
        this.paymentId = paymentId;
        this.token = token;
        // è®¡ç®— Token Hash
        this.tokenHash = crypto.createHash('sha256').update(token).digest('hex');
        this.nodelocUrl = nodelocUrl.replace(/\/$/, '');
    }

    /**
     * ç”Ÿæˆ HMAC-SHA256 ç­¾å
     */
    generateSignature(params) {
        // æŒ‰é”®åæ’åº
        const sortedKeys = Object.keys(params).sort();

        // æ‹¼æ¥å‚æ•°
        const paramString = sortedKeys
            .map(key => `${key}=${params[key]}`)
            .join('&');

        // ä½¿ç”¨ Token Hash è¿›è¡Œ HMAC-SHA256 åŠ å¯†
        return crypto
            .createHmac('sha256', this.tokenHash)
            .update(paramString)
            .digest('hex');
    }

    /**
     * åˆ›å»ºæ”¯ä»˜
     */
    async createPayment(userId, amount, description, orderId) {
        const params = {
            amount,
            description,
            order_id: orderId,
            user_id: userId,
        };

        const signature = this.generateSignature(params);
        params.signature = signature;

        const url = `${this.nodelocUrl}/payment/pay/${this.paymentId}/process`;

        try {
            const response = await axios.post(url, params, {
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            return response.data;
        } catch (error) {
            throw new Error(`Payment creation failed: ${error.response?.data || error.message}`);
        }
    }

    /**
     * éªŒè¯å›è°ƒç­¾å
     */
    verifyCallback(data) {
        const signature = data.signature;
        delete data.signature;

        const expectedSignature = this.generateSignature(data);
        return signature === expectedSignature;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const payment = new NodeLocPayment(
    'pay_a1b2c3d4',
    'tk_secret',  // åŸå§‹ Token
    'https://www.nodeloc.com'
);

// Express è·¯ç”±ç¤ºä¾‹
const express = require('express');
const app = express();
app.use(express.json());

// åˆ›å»ºæ”¯ä»˜
app.post('/create-payment', async (req, res) => {
    try {
        const result = await payment.createPayment(
            req.body.userId,
            req.body.amount,
            req.body.description,
            `ORDER_${Date.now()}`
        );

        res.json({ paymentUrl: result.payment_url });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// å¤„ç†å›è°ƒ
app.post('/payment/callback', (req, res) => {
    if (payment.verifyCallback(req.body)) {
        if (req.body.status === 'completed') {
            // æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°è®¢å•
            console.log('Payment completed:', req.body.order_id);
        }
        res.json({ success: true });
    } else {
        res.status(400).json({ error: 'Invalid signature' });
    }
});
```

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

| HTTP çŠ¶æ€ç  | é”™è¯¯ä¿¡æ¯                             | è¯´æ˜     | è§£å†³æ–¹æ¡ˆ                   |
| -------- | -------------------------------- | ------ | ---------------------- |
| 400      | Invalid signature                | ç­¾åéªŒè¯å¤±è´¥ | æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®ï¼Œç­¾åç®—æ³•æ˜¯å¦æ­£ç¡® |
| 400      | Insufficient points              | ç”¨æˆ·èƒ½é‡ä¸è¶³ | æç¤ºç”¨æˆ·å……å€¼èƒ½é‡               |
| 404      | Payment application not found    | åº”ç”¨ä¸å­˜åœ¨  | æ£€æŸ¥ Payment ID æ˜¯å¦æ­£ç¡®     |
| 403      | Payment application not approved | åº”ç”¨æœªæ‰¹å‡†  | ç­‰å¾…ç®¡ç†å‘˜æ‰¹å‡†åº”ç”¨              |
| 403      | Payment application suspended    | åº”ç”¨å·²æš‚åœ  | è”ç³»ç®¡ç†å‘˜æ¢å¤åº”ç”¨              |
| 422      | Invalid parameters               | å‚æ•°é”™è¯¯   | æ£€æŸ¥è¯·æ±‚å‚æ•°æ˜¯å¦å®Œæ•´ä¸”æ ¼å¼æ­£ç¡®        |
| 500      | Internal server error            | æœåŠ¡å™¨é”™è¯¯  | è”ç³»æŠ€æœ¯æ”¯æŒ                 |

### é”™è¯¯å“åº”ç¤ºä¾‹

```json
{
  "error": "Insufficient points",
  "message": "ç”¨æˆ·èƒ½é‡ä¸è¶³",
  "details": {
    "required": 100,
    "available": 50
  }
}
```

## å®‰å…¨å»ºè®®

### 1. Token å®‰å…¨

<div className="security-checklist">
- âœ… å°† Token å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œä¸è¦æš´éœ²ç»™å®¢æˆ·ç«¯
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–åŠ å¯†é…ç½®æ–‡ä»¶å­˜å‚¨ Token
- âœ… å®šæœŸè½®æ¢ Tokenï¼ˆä½¿ç”¨"é‡æ–°ç”Ÿæˆ Token"åŠŸèƒ½ï¼‰
- âŒ ä¸è¦å°† Token æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
- âŒ ä¸è¦åœ¨å‰ç«¯ JavaScript ä¸­ä½¿ç”¨ Token

</div>

### 2. å›è°ƒéªŒè¯

<div className="security-checklist">
- âœ… å§‹ç»ˆéªŒè¯å›è°ƒç­¾å
- âœ… éªŒè¯å›è°ƒæ¥æº IPï¼ˆå¯é€‰ï¼‰
- âœ… ä½¿ç”¨ HTTPS æ¥æ”¶å›è°ƒ
- âœ… å®ç°å¹‚ç­‰æ€§å¤„ç†ï¼Œé˜²æ­¢é‡å¤å¤„ç†åŒä¸€å›è°ƒ

</div>

### 3. é‡‘é¢éªŒè¯

<div className="security-checklist">
- âœ… åœ¨æœåŠ¡å™¨ç«¯éªŒè¯æ”¯ä»˜é‡‘é¢
- âœ… æ£€æŸ¥è®¢å•é‡‘é¢ä¸å›è°ƒé‡‘é¢æ˜¯å¦ä¸€è‡´
- âŒ ä¸è¦ä¿¡ä»»å®¢æˆ·ç«¯ä¼ é€’çš„é‡‘é¢

</div>

### 4. è®¢å•å·

<div className="security-checklist">
- âœ… ä½¿ç”¨å”¯ä¸€çš„è®¢å•å·
- âœ… åœ¨å›è°ƒä¸­éªŒè¯è®¢å•å·çš„æœ‰æ•ˆæ€§
- âœ… é˜²æ­¢è®¢å•å·è¢«é‡å¤ä½¿ç”¨

</div>

### 5. ç½‘ç»œå®‰å…¨

<div className="security-checklist">
- âœ… ä½¿ç”¨ HTTPS è¿›è¡Œæ‰€æœ‰é€šä¿¡
- âœ… å®ç°è¯·æ±‚é¢‘ç‡é™åˆ¶
- âœ… è®°å½•æ‰€æœ‰æ”¯ä»˜è¯·æ±‚å’Œå›è°ƒæ—¥å¿—

</div>

## æµ‹è¯•å»ºè®®

<info>
  **æœ€ä½³å®è·µ**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šçº¿å‰ï¼ŒåŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒå®Œæˆå……åˆ†çš„æµ‹è¯•ã€‚
</info>

1. **æµ‹è¯•ç¯å¢ƒ**: å…ˆåœ¨æµ‹è¯•ç¯å¢ƒå®Œæˆé›†æˆå’Œæµ‹è¯•
2. **å°é¢æµ‹è¯•**: ä½¿ç”¨å°é¢èƒ½é‡è¿›è¡Œæµ‹è¯•
3. **å¼‚å¸¸æƒ…å†µ**: æµ‹è¯•èƒ½é‡ä¸è¶³ã€ç­¾åé”™è¯¯ç­‰å¼‚å¸¸æƒ…å†µ
4. **å¹¶å‘æµ‹è¯•**: æµ‹è¯•å¹¶å‘æ”¯ä»˜è¯·æ±‚
5. **å›è°ƒæµ‹è¯•**: ç¡®ä¿å›è°ƒå¤„ç†æ­£ç¡®

---

<style jsx>
  {`
  .api-endpoint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 1rem 0;
    padding: 1rem;
    background: #f6f8fa;
    border-radius: 6px;
    font-family: monospace;
  }

  .method {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.875rem;
    text-transform: uppercase;
  }

  .method.post {
    background: #10b981;
    color: white;
  }

  .method.get {
    background: #3b82f6;
    color: white;
  }

  .security-checklist {
    background: #f9fafb;
    border-left: 4px solid #3b82f6;
    padding: 1rem 1.5rem;
    margin: 1rem 0;
  }

  .security-checklist li {
    margin: 0.5rem 0;
  }

  .changelog {
    border-left: 4px solid #10b981;
    padding-left: 1.5rem;
    margin: 2rem 0;
  }

  .changelog h3 {
    color: #059669;
    margin-top: 1.5rem;
  }

  .footer-note {
    text-align: center;
    color: #6b7280;
    font-size: 0.875rem;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }

  dl {
    margin: 1rem 0;
  }

  dt {
    margin-top: 1rem;
    color: #1f2937;
  }

  dd {
    margin-left: 1.5rem;
    color: #6b7280;
  }
  `}
</style>