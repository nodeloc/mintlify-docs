---
title: "NodeLoc OAuth Provider å¯¹æ¥æ–‡æ¡£"
description: "æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„ç¬¬ä¸‰æ–¹åº”ç”¨å¯¹æ¥æŒ‡å—ï¼Œå¸®åŠ©æ‚¨å°† NodeLoc OAuth Provider é›†æˆåˆ°æ‚¨çš„åº”ç”¨ä¸­ã€‚"
---

# NodeLoc OAuth Provider å¯¹æ¥æ–‡æ¡£

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„ç¬¬ä¸‰æ–¹åº”ç”¨å¯¹æ¥æŒ‡å—ï¼Œå¸®åŠ©æ‚¨å°† NodeLoc OAuth Provider é›†æˆåˆ°æ‚¨çš„åº”ç”¨ä¸­ã€‚

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [OAuth 2.0 æˆæƒæµç¨‹](#oauth-20-æˆæƒæµç¨‹)
- [API ç«¯ç‚¹](#api-ç«¯ç‚¹)
- [é›†æˆç¤ºä¾‹](#é›†æˆç¤ºä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»º OAuth åº”ç”¨

è®¿é—® NodeLoc è®ºå›å¹¶åˆ›å»º OAuth åº”ç”¨ï¼š

```
https://www.nodeloc.com/oauth-provider/applications
```

è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š

- **Client ID**: åº”ç”¨çš„å”¯ä¸€æ ‡è¯†ç¬¦
- **Client Secret**: åº”ç”¨å¯†é’¥ï¼ˆè¯·å¦¥å–„ä¿ç®¡ï¼‰
- **Redirect URI**: æˆæƒåçš„å›è°ƒåœ°å€

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
NODELOC_URL=https://www.nodeloc.com
NODELOC_CLIENT_ID=your-client-id
NODELOC_CLIENT_SECRET=your-client-secret
NODELOC_REDIRECT_URI=http://yoururl.com/auth/callback
```

### 3. å¼€å§‹é›†æˆ

é€‰æ‹©æ‚¨çš„å¼€å‘è¯­è¨€ï¼Œå‚è€ƒä¸‹æ–¹çš„é›†æˆç¤ºä¾‹å¿«é€Ÿå¼€å§‹ã€‚

---

## ğŸ” OAuth 2.0 æˆæƒæµç¨‹

### æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant App as æ‚¨çš„åº”ç”¨
    participant Discourse as Discourse OAuth
    
    User->>App: 1. ç‚¹å‡»ç™»å½•
    App->>Discourse: 2. é‡å®šå‘åˆ°æˆæƒé¡µé¢
    Discourse->>User: 3. æ˜¾ç¤ºæˆæƒç¡®è®¤
    User->>Discourse: 4. åŒæ„æˆæƒ
    Discourse->>App: 5. å›è°ƒå¹¶è¿”å›æˆæƒç 
    App->>Discourse: 6. ä½¿ç”¨æˆæƒç äº¤æ¢ Token
    Discourse->>App: 7. è¿”å› Access Token
    App->>Discourse: 8. ä½¿ç”¨ Token è·å–ç”¨æˆ·ä¿¡æ¯
    Discourse->>App: 9. è¿”å›ç”¨æˆ·ä¿¡æ¯
    App->>User: 10. ç™»å½•æˆåŠŸ
```

### è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤ 1: é‡å®šå‘åˆ°æˆæƒé¡µé¢

å°†ç”¨æˆ·é‡å®šå‘åˆ°ä»¥ä¸‹ URLï¼š

```
https://www.nodeloc.com/oauth-provider/authorize?
  client_id=YOUR_CLIENT_ID&
  redirect_uri=YOUR_REDIRECT_URI&
  response_type=code&
  scope=openid%20profile&
  state=RANDOM_STATE_STRING
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•°              | å¿…å¡« | è¯´æ˜                               |
| --------------- | --- | -------------------------------- |
| `client_id`     | âœ“  | æ‚¨çš„åº”ç”¨ Client ID                   |
| `redirect_uri`  | âœ“  | æˆæƒåçš„å›è°ƒåœ°å€ï¼ˆå¿…é¡»ä¸åº”ç”¨é…ç½®ä¸€è‡´ï¼‰              |
| `response_type` | âœ“  | å›ºå®šå€¼ï¼š`code`                       |
| `scope`         | -  | è¯·æ±‚çš„æƒé™èŒƒå›´ï¼Œå¦‚ `openid profile email` |
| `state`         | æ¨è | éšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºé˜²æ­¢ CSRF æ”»å‡»               |

#### æ­¥éª¤ 2: æ¥æ”¶æˆæƒç 

ç”¨æˆ·æˆæƒåï¼ŒNodelLoc ä¼šé‡å®šå‘å›æ‚¨çš„ `redirect_uri`ï¼Œå¹¶é™„å¸¦æˆæƒç ï¼š

```
https://your-app.com/callback?
  code=AUTHORIZATION_CODE&
  state=YOUR_STATE_STRING
```

**å®‰å…¨æç¤ºï¼š** è¯·éªŒè¯ `state` å‚æ•°æ˜¯å¦ä¸æ­¥éª¤ 1 å‘é€çš„ä¸€è‡´ã€‚

#### æ­¥éª¤ 3: äº¤æ¢ Access Token

ä½¿ç”¨æˆæƒç äº¤æ¢ Access Tokenï¼š

```bash
curl -X POST https://www.nodeloc.com/oauth-provider/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code" \
  -d "code=AUTHORIZATION_CODE" \
  -d "redirect_uri=YOUR_REDIRECT_URI" \
  -d "client_id=YOUR_CLIENT_ID" \
  -d "client_secret=YOUR_CLIENT_SECRET"
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 7200,
  "refresh_token": "optional_refresh_token",
  "scope": "openid profile email"
}
```

#### æ­¥éª¤ 4: è·å–ç”¨æˆ·ä¿¡æ¯

ä½¿ç”¨ Access Token è·å–ç”¨æˆ·ä¿¡æ¯ï¼š

```bash
curl -X GET https://www.nodeloc.com/oauth-provider/userinfo \
  -H "Authorization: Bearer ACCESS_TOKEN"
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "id": 123,
  "username": "user1",
  "name": "user1",
  "avatar_url": "https://discourse.com/avatar.png",
  "trust_level": 2
}
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ            | ç±»å‹      | è¯´æ˜                      |
| ------------- | ------- | ----------------------- |
| `id`          | integer | ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦                |
| `username`    | string  | ç”¨æˆ·å                     |
| `name`        | string  | æ˜¾ç¤ºåç§°ï¼ˆå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ usernameï¼‰ |
| `avatar_url`  | string  | ç”¨æˆ·å¤´åƒ URL                |
| `trust_level` | integer | ç”¨æˆ·ä¿¡ä»»ç­‰çº§ï¼ˆ0-4ï¼‰             |

---

## ğŸ”Œ API ç«¯ç‚¹

### æˆæƒç«¯ç‚¹

```
GET /oauth-provider/authorize
```

ç”¨äºå‘èµ·æˆæƒè¯·æ±‚ï¼Œç”¨æˆ·éœ€è¦åœ¨æµè§ˆå™¨ä¸­è®¿é—®æ­¤ç«¯ç‚¹ã€‚

### Token ç«¯ç‚¹

```
POST /oauth-provider/token
```

ç”¨äºäº¤æ¢æˆæƒç è·å– Access Tokenï¼Œæˆ–ä½¿ç”¨ Refresh Token åˆ·æ–°è®¿é—®ä»¤ç‰Œã€‚

**æ”¯æŒçš„ Grant Typesï¼š**

- `authorization_code` - æˆæƒç æ¨¡å¼
- `refresh_token` - åˆ·æ–°ä»¤ç‰Œï¼ˆå¦‚æœæ”¯æŒï¼‰

### UserInfo ç«¯ç‚¹

```
GET /oauth-provider/userinfo
```

ä½¿ç”¨ Access Token è·å–å½“å‰æˆæƒç”¨æˆ·çš„ä¿¡æ¯ã€‚

**è¯·æ±‚å¤´ï¼š**

```
Authorization: Bearer YOUR_ACCESS_TOKEN
```

### OIDC Discovery ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰

```
GET /.well-known/openid-configuration
```

è¿”å› OIDC é…ç½®ä¿¡æ¯ï¼Œæ”¯æŒè‡ªåŠ¨å‘ç°ã€‚

---

---

## â“ å¸¸è§é—®é¢˜

### 1. å¦‚ä½•å¤„ç† Token è¿‡æœŸï¼Ÿ

Access Token é»˜è®¤æœ‰æ•ˆæœŸä¸º 2 å°æ—¶ï¼ˆ7200 ç§’ï¼‰ã€‚è¿‡æœŸåéœ€è¦é‡æ–°æˆæƒï¼Œæˆ–ä½¿ç”¨ Refresh Tokenï¼ˆå¦‚æœæ”¯æŒï¼‰ã€‚

```javascript
// æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
function isTokenExpired(expiresAt) {
  return Date.now() >= expiresAt * 1000;
}

// ä½¿ç”¨ Refresh Token åˆ·æ–°
async function refreshAccessToken(refreshToken) {
  const response = await fetch(`${DISCOURSE_URL}/oauth-provider/token`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({
      grant_type: 'refresh_token',
      refresh_token: refreshToken,
      client_id: CLIENT_ID,
      client_secret: CLIENT_SECRET
    })
  });
  
  return await response.json();
}
```

### 2. å¦‚ä½•å¤„ç†é”™è¯¯ï¼Ÿ

æ‰€æœ‰é”™è¯¯éƒ½ä¼šè¿”å›æ ‡å‡†çš„ OAuth 2.0 é”™è¯¯æ ¼å¼ï¼š

```json
{
  "error": "invalid_client",
  "error_description": "Invalid client credentials"
}
```

**å¸¸è§é”™è¯¯ä»£ç ï¼š**

| é”™è¯¯ä»£ç                      | è¯´æ˜                    | è§£å†³æ–¹æ³•                    |
| ------------------------ | --------------------- | ----------------------- |
| `invalid_request`        | è¯·æ±‚å‚æ•°ç¼ºå¤±æˆ–æ— æ•ˆ             | æ£€æŸ¥å¿…å¡«å‚æ•°                  |
| `invalid_client`         | Client ID æˆ– Secret æ— æ•ˆ | éªŒè¯åº”ç”¨å‡­è¯                  |
| `invalid_grant`          | æˆæƒç æ— æ•ˆæˆ–å·²è¿‡æœŸ             | é‡æ–°å‘èµ·æˆæƒ                  |
| `unauthorized_client`    | å®¢æˆ·ç«¯æœªæˆæƒ                | æ£€æŸ¥åº”ç”¨çŠ¶æ€                  |
| `unsupported_grant_type` | ä¸æ”¯æŒçš„ Grant Type       | ä½¿ç”¨ `authorization_code` |
| `invalid_token`          | Access Token æ— æ•ˆ       | é‡æ–°è·å– Token              |

### 3. name å­—æ®µä¸ºç©ºæ€ä¹ˆåŠï¼Ÿ

å½“ç”¨æˆ·æ²¡æœ‰è®¾ç½®æ˜¾ç¤ºåç§°æ—¶ï¼Œ`name` å­—æ®µä¼šè‡ªåŠ¨ä½¿ç”¨ `username` çš„å€¼ã€‚æ‚¨ä¸éœ€è¦åšé¢å¤–å¤„ç†ã€‚

```javascript
// UserInfo å“åº”ç¤ºä¾‹ï¼ˆname ä¸ºç©ºæ—¶ï¼‰
{
  "id": 123,
  "username": "user1",
  "name": "user1",  // è‡ªåŠ¨ä½¿ç”¨ username
  "avatar_url": "...",
  "trust_level": 1
}
```

### 4. å¦‚ä½•æµ‹è¯• OAuth é›†æˆï¼Ÿ

ä½¿ç”¨ä»¥ä¸‹æµ‹è¯•è„šæœ¬å¿«é€ŸéªŒè¯ï¼š

```bash
# 1. åœ¨æµè§ˆå™¨ä¸­è®¿é—®æˆæƒ URL
https://www.nodeloc.com/oauth-provider/authorize?client_id=YOUR_ID&redirect_uri=http://localhost:3000/callback&response_type=code&state=test

# 2. æˆæƒåè·å– codeï¼Œç„¶åäº¤æ¢ Token
curl -X POST https://www.nodeloc.com/oauth-provider/token \
  -d "grant_type=authorization_code" \
  -d "code=YOUR_CODE" \
  -d "redirect_uri=http://localhost:3000/callback" \
  -d "client_id=YOUR_ID" \
  -d "client_secret=YOUR_SECRET"

# 3. ä½¿ç”¨ Token è·å–ç”¨æˆ·ä¿¡æ¯
curl -X GET https://www.nodeloc.com/oauth-provider/userinfo \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### 5. æ”¯æŒå“ªäº› Scopeï¼Ÿ

ç›®å‰æ”¯æŒä»¥ä¸‹ scopeï¼š

- `openid` - OpenID Connect åŸºç¡€æ”¯æŒ
- `profile` - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆusername, nameï¼‰

ç¤ºä¾‹ï¼š

```
scope=openid profile
```

### 6. å¦‚ä½•ä¿æŠ¤ Client Secretï¼Ÿ

**é‡è¦å®‰å…¨æç¤ºï¼š**

- âœ… **æœåŠ¡ç«¯å­˜å‚¨**: å°† Client Secret å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ç¯å¢ƒå˜é‡ä¸­
- âœ… **HTTPS é€šä¿¡**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- âœ… **å®šæœŸæ›´æ¢**: å®šæœŸåœ¨ NodeLocä¸­é‡æ–°ç”Ÿæˆ Client Secret
- âŒ **ä¸è¦æš´éœ²**: æ°¸è¿œä¸è¦å°† Secret æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶æˆ–å‰ç«¯ä»£ç ä¸­
- âŒ **ä¸è¦è®°å½•**: ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•å®Œæ•´çš„ Secret

### 7. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- ä½¿ç”¨ HTTPS åè®®
- é…ç½®æ­£ç¡®çš„ Redirect URI
- ç¯å¢ƒå˜é‡å®‰å…¨å­˜å‚¨
- å®ç°é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- æ·»åŠ  State å‚æ•°é˜²æ­¢ CSRF
- å®ç° Token åˆ·æ–°æœºåˆ¶
- é…ç½®ä¼šè¯è¶…æ—¶
- æ·»åŠ ç”¨æˆ·é€€å‡ºç™»å½•åŠŸèƒ½
- æµ‹è¯•å®Œæ•´çš„æˆæƒæµç¨‹