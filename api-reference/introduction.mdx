---
title: NodeLoc OAuth Provider å¯¹æ¥æ–‡æ¡£
description: å®Œæ•´çš„ç¬¬ä¸‰æ–¹åº”ç”¨å¯¹æ¥æŒ‡å—ï¼Œæ”¯æŒ OAuth 2.0 å’Œ OpenID Connect
---

# NodeLoc OAuth Provider å¯¹æ¥æ–‡æ¡£

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„ç¬¬ä¸‰æ–¹åº”ç”¨å¯¹æ¥æŒ‡å—ï¼Œå¸®åŠ©æ‚¨å°† NodeLoc OAuth Provider é›†æˆåˆ°æ‚¨çš„åº”ç”¨ä¸­ã€‚

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [OAuth 2.0 æˆæƒæµç¨‹](#oauth-20-æˆæƒæµç¨‹)
- [API ç«¯ç‚¹](#api-ç«¯ç‚¹)
- [é›†æˆç¤ºä¾‹](#é›†æˆç¤ºä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»º OAuth åº”ç”¨

è®¿é—® NodeLoc è®ºå›å¹¶åˆ›å»º OAuth åº”ç”¨ï¼š

```
https://www.nodeloc.com.com/oauth-provider/applications
```

è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
- **Client ID**: åº”ç”¨çš„å”¯ä¸€æ ‡è¯†ç¬¦
- **Client Secret**: åº”ç”¨å¯†é’¥ï¼ˆè¯·å¦¥å–„ä¿ç®¡ï¼‰
- **Redirect URI**: æˆæƒåçš„å›è°ƒåœ°å€

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
NodeLoc_URL=https://www.nodeloc.com.com
NodeLoc_CLIENT_ID=your-client-id
NodeLoc_CLIENT_SECRET=your-client-secret
NodeLoc_REDIRECT_URI=http://your-url.com/auth/callback
```

### 3. å¼€å§‹é›†æˆ

é€‰æ‹©æ‚¨çš„å¼€å‘è¯­è¨€ï¼Œå‚è€ƒä¸‹æ–¹çš„é›†æˆç¤ºä¾‹å¿«é€Ÿå¼€å§‹ã€‚

---

## ğŸ” OAuth 2.0 æˆæƒæµç¨‹

### æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant App as æ‚¨çš„åº”ç”¨
    participant NodeLoc as NodeLoc OAuth
    
    User->>App: 1. ç‚¹å‡»ç™»å½•
    App->>NodeLoc: 2. é‡å®šå‘åˆ°æˆæƒé¡µé¢
    NodeLoc->>User: 3. æ˜¾ç¤ºæˆæƒç¡®è®¤
    User->>NodeLoc: 4. åŒæ„æˆæƒ
    NodeLoc->>App: 5. å›è°ƒå¹¶è¿”å›æˆæƒç 
    App->>NodeLoc: 6. ä½¿ç”¨æˆæƒç äº¤æ¢ Token
    NodeLoc->>App: 7. è¿”å› Access Token
    App->>NodeLoc: 8. ä½¿ç”¨ Token è·å–ç”¨æˆ·ä¿¡æ¯
    NodeLoc->>App: 9. è¿”å›ç”¨æˆ·ä¿¡æ¯
    App->>User: 10. ç™»å½•æˆåŠŸ
```

### è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤ 1: é‡å®šå‘åˆ°æˆæƒé¡µé¢

å°†ç”¨æˆ·é‡å®šå‘åˆ°ä»¥ä¸‹ URLï¼š

```
https://www.nodeloc.com.com/oauth-provider/authorize?
  client_id=YOUR_CLIENT_ID&
  redirect_uri=YOUR_REDIRECT_URI&
  response_type=code&
  scope=openid%20profile%20email&
  state=RANDOM_STATE_STRING
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| `client_id` | âœ“ | æ‚¨çš„åº”ç”¨ Client ID |
| `redirect_uri` | âœ“ | æˆæƒåçš„å›è°ƒåœ°å€ï¼ˆå¿…é¡»ä¸åº”ç”¨é…ç½®ä¸€è‡´ï¼‰ |
| `response_type` | âœ“ | å›ºå®šå€¼ï¼š`code` |
| `scope` | - | è¯·æ±‚çš„æƒé™èŒƒå›´ï¼Œå¦‚ `openid profile email`ï¼ˆè¯¦è§ä¸‹æ–¹è¯´æ˜ï¼‰ |
| `state` | æ¨è | éšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºé˜²æ­¢ CSRF æ”»å‡» |

**å¯ç”¨çš„ Scopeï¼ˆæƒé™èŒƒå›´ï¼‰ï¼š**

| Scope | è¯´æ˜ | æ˜¯å¦å¿…éœ€ | éœ€è¦å®¡æ ¸ |
|-------|------|----------|----------|
| `openid` | æ ‡å‡† OpenID Connect scope | **æ˜¯ï¼ˆå¿…éœ€ï¼‰** | å¦ |
| `profile` | ç”¨æˆ·èµ„æ–™ï¼ˆå¤´åƒã€ç®€ä»‹ç­‰ï¼‰ | å¦ | å¦ |
| `email` | ç”¨æˆ·é‚®ç®±åœ°å€ | å¦ | **æ˜¯** |

**æ³¨æ„äº‹é¡¹ï¼š**
- å¦‚æœåº”ç”¨ç”³è¯·äº† `email` æƒé™ï¼Œéœ€è¦ç®¡ç†å‘˜å®¡æ ¸åæ‰èƒ½ä½¿ç”¨
- å®¡æ ¸çŠ¶æ€å¯ä»¥åœ¨åº”ç”¨ç®¡ç†é¡µé¢æŸ¥çœ‹
- æœªé€šè¿‡å®¡æ ¸çš„åº”ç”¨å°†æ— æ³•å®Œæˆæˆæƒæµç¨‹

#### æ­¥éª¤ 2: æ¥æ”¶æˆæƒç 

ç”¨æˆ·æˆæƒåï¼ŒNodeLoc ä¼šé‡å®šå‘å›æ‚¨çš„ `redirect_uri`ï¼Œå¹¶é™„å¸¦æˆæƒç ï¼š

**æˆæƒæˆåŠŸï¼š**
```
https://your-app.com/callback?
  code=AUTHORIZATION_CODE&
  state=YOUR_STATE_STRING
```

**ç”¨æˆ·æ‹’ç»æˆæƒï¼š**
```
https://your-app.com/callback?
  error=access_denied&
  error_description=The+resource+owner+or+authorization+server+denied+the+request&
  state=YOUR_STATE_STRING
```

**é”™è¯¯å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | è¯´æ˜ |
|------|------|
| `error` | é”™è¯¯ä»£ç ï¼Œ`access_denied` è¡¨ç¤ºç”¨æˆ·æ‹’ç»æˆæƒ |
| `error_description` | é”™è¯¯æè¿°ä¿¡æ¯ |
| `state` | æ‚¨åœ¨æ­¥éª¤ 1 ä¸­å‘é€çš„ state å‚æ•° |

**å¤„ç†å»ºè®®ï¼š**
- æ£€æŸ¥æ˜¯å¦å­˜åœ¨ `error` å‚æ•°æ¥åˆ¤æ–­æˆæƒæ˜¯å¦æˆåŠŸ
- å¦‚æœç”¨æˆ·æ‹’ç»æˆæƒï¼Œåº”è¯¥å‹å¥½åœ°æç¤ºç”¨æˆ·ï¼Œå¹¶æä¾›é‡æ–°æˆæƒçš„é€‰é¡¹
- è®°å½•æ‹’ç»æˆæƒçš„äº‹ä»¶ï¼Œä»¥ä¾¿åˆ†æç”¨æˆ·è¡Œä¸º

**ç¤ºä¾‹ä»£ç ï¼ˆNode.jsï¼‰ï¼š**
```javascript
app.get('/callback', (req, res) => {
  const { code, error, error_description, state } = req.query;
  
  // éªŒè¯ state å‚æ•°
  if (state !== req.session.oauthState) {
    return res.status(400).send('Invalid state parameter');
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
  if (error) {
    if (error === 'access_denied') {
      // ç”¨æˆ·æ‹’ç»æˆæƒ
      return res.send(`
        <h1>æˆæƒè¢«æ‹’ç»</h1>
        <p>æ‚¨æ‹’ç»äº†æˆæƒè¯·æ±‚ã€‚å¦‚éœ€ä½¿ç”¨æ­¤æœåŠ¡ï¼Œè¯·<a href="/auth/NodeLoc">é‡æ–°æˆæƒ</a>ã€‚</p>
      `);
    }
    // å…¶ä»–é”™è¯¯
    return res.status(400).send(`æˆæƒé”™è¯¯: ${error_description || error}`);
  }
  
  // ç»§ç»­å¤„ç†æˆæƒç ...
});
```

**å®‰å…¨æç¤ºï¼š** è¯·éªŒè¯ `state` å‚æ•°æ˜¯å¦ä¸æ­¥éª¤ 1 å‘é€çš„ä¸€è‡´ã€‚

#### æ­¥éª¤ 3: äº¤æ¢ Access Token

ä½¿ç”¨æˆæƒç äº¤æ¢ Access Tokenï¼š

```bash
curl -X POST https://www.nodeloc.com.com/oauth-provider/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=authorization_code" \
  -d "code=AUTHORIZATION_CODE" \
  -d "redirect_uri=YOUR_REDIRECT_URI" \
  -d "client_id=YOUR_CLIENT_ID" \
  -d "client_secret=YOUR_CLIENT_SECRET"
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 7200,
  "refresh_token": "optional_refresh_token",
  "scope": "openid profile email"
}
```

#### æ­¥éª¤ 4: è·å–ç”¨æˆ·ä¿¡æ¯

ä½¿ç”¨ Access Token è·å–ç”¨æˆ·ä¿¡æ¯ï¼š

```bash
curl -X GET https://www.nodeloc.com.com/oauth-provider/userinfo \
  -H "Authorization: Bearer ACCESS_TOKEN"
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "id": 123,
  "username": "user1",
  "name": "user1",
  "avatar_url": "https://NodeLoc.com/avatar.png",
  "trust_level": 2,
  "email": "user1@example.com"
}
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | integer | ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| `username` | string | ç”¨æˆ·å |
| `name` | string | æ˜¾ç¤ºåç§°ï¼ˆå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ usernameï¼‰ |
| `avatar_url` | string | ç”¨æˆ·å¤´åƒ URL |
| `trust_level` | integer | ç”¨æˆ·ä¿¡ä»»ç­‰çº§ï¼ˆ0-4ï¼‰ |
| `email` | string | ç”¨æˆ·é‚®ç®±ï¼ˆä»…å½“ scope åŒ…å« `email` æ—¶è¿”å›ï¼‰ |

---

## ğŸ”Œ API ç«¯ç‚¹

### æˆæƒç«¯ç‚¹

```
GET /oauth-provider/authorize
```

ç”¨äºå‘èµ·æˆæƒè¯·æ±‚ï¼Œç”¨æˆ·éœ€è¦åœ¨æµè§ˆå™¨ä¸­è®¿é—®æ­¤ç«¯ç‚¹ã€‚

### Token ç«¯ç‚¹

```
POST /oauth-provider/token
```

ç”¨äºäº¤æ¢æˆæƒç è·å– Access Tokenï¼Œæˆ–ä½¿ç”¨ Refresh Token åˆ·æ–°è®¿é—®ä»¤ç‰Œã€‚

**æ”¯æŒçš„ Grant Typesï¼š**
- `authorization_code` - æˆæƒç æ¨¡å¼
- `refresh_token` - åˆ·æ–°ä»¤ç‰Œï¼ˆå¦‚æœæ”¯æŒï¼‰

### UserInfo ç«¯ç‚¹

```
GET /oauth-provider/userinfo
```

ä½¿ç”¨ Access Token è·å–å½“å‰æˆæƒç”¨æˆ·çš„ä¿¡æ¯ã€‚

**è¯·æ±‚å¤´ï¼š**
```
Authorization: Bearer YOUR_ACCESS_TOKEN
```

### OIDC Discovery ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰

```
GET /.well-known/openid-configuration
```

è¿”å› OIDC é…ç½®ä¿¡æ¯ï¼Œæ”¯æŒè‡ªåŠ¨å‘ç°ã€‚

---

## ğŸ’» é›†æˆç¤ºä¾‹

### Node.js + Express

#### å®‰è£…ä¾èµ–

```bash
npm install express express-session passport passport-oauth2
```

#### å®Œæ•´ç¤ºä¾‹ä»£ç 

```javascript
const express = require('express');
const session = require('express-session');
const passport = require('passport');
const OAuth2Strategy = require('passport-oauth2');

const app = express();

// é…ç½® Session
app.use(session({
  secret: 'your-secret-key',
  resave: false,
  saveUninitialized: false,
  cookie: { secure: false } // ç”Ÿäº§ç¯å¢ƒè¯·è®¾ç½®ä¸º true
}));

app.use(passport.initialize());
app.use(passport.session());

// é…ç½® NodeLoc OAuth2 ç­–ç•¥
passport.use('NodeLoc', new OAuth2Strategy({
    authorizationURL: `${process.env.NodeLoc_URL}/oauth-provider/authorize`,
    tokenURL: `${process.env.NodeLoc_URL}/oauth-provider/token`,
    clientID: process.env.NodeLoc_CLIENT_ID,
    clientSecret: process.env.NodeLoc_CLIENT_SECRET,
    callbackURL: process.env.NodeLoc_REDIRECT_URI,
    scope: ['openid', 'profile', 'email']
  },
  async (accessToken, refreshToken, profile, done) => {
    try {
      // è·å–ç”¨æˆ·ä¿¡æ¯
      const response = await fetch(
        `${process.env.NodeLoc_URL}/oauth-provider/userinfo`,
        {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        }
      );
      
      const user = await response.json();
      
      // å°† access_token ä¿å­˜åˆ°ç”¨æˆ·å¯¹è±¡
      user.accessToken = accessToken;
      user.refreshToken = refreshToken;
      
      return done(null, user);
    } catch (error) {
      return done(error);
    }
  }
));

// åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç”¨æˆ·
passport.serializeUser((user, done) => {
  done(null, user);
});

passport.deserializeUser((user, done) => {
  done(null, user);
});

// è·¯ç”±

// é¦–é¡µ - æ˜¾ç¤ºç™»å½•çŠ¶æ€
app.get('/', (req, res) => {
  if (req.isAuthenticated()) {
    res.send(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>æ¬¢è¿</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              max-width: 600px;
              margin: 50px auto;
              padding: 20px;
            }
            .user-card {
              border: 1px solid #ddd;
              border-radius: 8px;
              padding: 20px;
              background: #f9f9f9;
            }
            .avatar {
              width: 80px;
              height: 80px;
              border-radius: 50%;
            }
            .logout-btn {
              background: #dc3545;
              color: white;
              padding: 10px 20px;
              text-decoration: none;
              border-radius: 4px;
              display: inline-block;
              margin-top: 15px;
            }
          </style>
        </head>
        <body>
          <div class="user-card">
            <h1>æ¬¢è¿ï¼Œ${req.user.name}ï¼</h1>
            <img src="${req.user.avatar_url}" alt="Avatar" class="avatar" />
            <p><strong>ç”¨æˆ·åï¼š</strong> ${req.user.username}</p>
            <p><strong>ç”¨æˆ· IDï¼š</strong> ${req.user.id}</p>
            <p><strong>ä¿¡ä»»ç­‰çº§ï¼š</strong> ${req.user.trust_level}</p>
            <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
          </div>
        </body>
      </html>
    `);
  } else {
    res.send(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>ç™»å½•</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              display: flex;
              justify-content: center;
              align-items: center;
              height: 100vh;
              margin: 0;
            }
            .login-btn {
              background: #0088cc;
              color: white;
              padding: 15px 30px;
              text-decoration: none;
              border-radius: 4px;
              font-size: 18px;
            }
            .login-btn:hover {
              background: #006699;
            }
          </style>
        </head>
        <body>
          <a href="/auth/NodeLoc" class="login-btn">ä½¿ç”¨ NodeLoc ç™»å½•</a>
        </body>
      </html>
    `);
  }
});

// å‘èµ·æˆæƒ
app.get('/auth/NodeLoc', passport.authenticate('NodeLoc'));

// æˆæƒå›è°ƒ
app.get('/auth/callback',
  passport.authenticate('NodeLoc', { failureRedirect: '/login' }),
  (req, res) => {
    // ç™»å½•æˆåŠŸï¼Œé‡å®šå‘åˆ°é¦–é¡µ
    res.redirect('/');
  }
);

// é€€å‡ºç™»å½•
app.get('/logout', (req, res) => {
  req.logout((err) => {
    if (err) {
      return res.redirect('/');
    }
    res.redirect('/');
  });
});

// API ç¤ºä¾‹ - è·å–å½“å‰ç”¨æˆ·
app.get('/api/me', (req, res) => {
  if (!req.isAuthenticated()) {
    return res.status(401).json({ error: 'Not authenticated' });
  }
  
  res.json({
    id: req.user.id,
    username: req.user.username,
    name: req.user.name,
    avatar_url: req.user.avatar_url,
    trust_level: req.user.trust_level
  });
});

// å¯åŠ¨æœåŠ¡å™¨
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:${PORT}`);
  console.log(`è¯·ç¡®ä¿è®¾ç½®äº†ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š`);
  console.log(`  - NodeLoc_URL`);
  console.log(`  - NodeLoc_CLIENT_ID`);
  console.log(`  - NodeLoc_CLIENT_SECRET`);
  console.log(`  - NodeLoc_REDIRECT_URI`);
});
```

#### ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
NodeLoc_URL=https://www.nodeloc.com.com
NodeLoc_CLIENT_ID=your-client-id
NodeLoc_CLIENT_SECRET=your-client-secret
NodeLoc_REDIRECT_URI=http://your-url.com/auth/callback
PORT=3000
```

#### è¿è¡Œåº”ç”¨

```bash
node app.js
```

è®¿é—® `http://your-url.com` å³å¯çœ‹åˆ°ç™»å½•é¡µé¢ã€‚

---

### Python + Flask

#### å®‰è£…ä¾èµ–

```bash
pip install flask authlib requests
```

#### å®Œæ•´ç¤ºä¾‹ä»£ç 

```python
from flask import Flask, redirect, url_for, session, jsonify
from authlib.integrations.flask_client import OAuth
import os

app = Flask(__name__)
app.secret_key = os.urandom(24)

# é…ç½® OAuth
oauth = OAuth(app)

NodeLoc = oauth.register(
    name='NodeLoc',
    client_id=os.getenv('NodeLoc_CLIENT_ID'),
    client_secret=os.getenv('NodeLoc_CLIENT_SECRET'),
    authorize_url=f"{os.getenv('NodeLoc_URL')}/oauth-provider/authorize",
    access_token_url=f"{os.getenv('NodeLoc_URL')}/oauth-provider/token",
    userinfo_endpoint=f"{os.getenv('NodeLoc_URL')}/oauth-provider/userinfo",
    client_kwargs={
        'scope': 'openid profile email'
    }
)

@app.route('/')
def index():
    """é¦–é¡µ - æ˜¾ç¤ºç™»å½•çŠ¶æ€"""
    user = session.get('user')
    
    if user:
        return f'''
            <!DOCTYPE html>
            <html>
                <head>
                    <meta charset="utf-8">
                    <title>æ¬¢è¿</title>
                    <style>
                        body {{
                            font-family: Arial, sans-serif;
                            max-width: 600px;
                            margin: 50px auto;
                            padding: 20px;
                        }}
                        .user-card {{
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            padding: 20px;
                            background: #f9f9f9;
                        }}
                        .avatar {{
                            width: 80px;
                            height: 80px;
                            border-radius: 50%;
                        }}
                        .logout-btn {{
                            background: #dc3545;
                            color: white;
                            padding: 10px 20px;
                            text-decoration: none;
                            border-radius: 4px;
                            display: inline-block;
                            margin-top: 15px;
                        }}
                    </style>
                </head>
                <body>
                    <div class="user-card">
                        <h1>æ¬¢è¿ï¼Œ{user['name']}ï¼</h1>
                        <img src="{user['avatar_url']}" alt="Avatar" class="avatar" />
                        <p><strong>ç”¨æˆ·åï¼š</strong> {user['username']}</p>
                        <p><strong>ç”¨æˆ· IDï¼š</strong> {user['id']}</p>
                        <p><strong>ä¿¡ä»»ç­‰çº§ï¼š</strong> {user['trust_level']}</p>
                        <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
                    </div>
                </body>
            </html>
        '''
    
    return '''
        <!DOCTYPE html>
        <html>
            <head>
                <meta charset="utf-8">
                <title>ç™»å½•</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        height: 100vh;
                        margin: 0;
                    }
                    .login-btn {
                        background: #0088cc;
                        color: white;
                        padding: 15px 30px;
                        text-decoration: none;
                        border-radius: 4px;
                        font-size: 18px;
                    }
                    .login-btn:hover {
                        background: #006699;
                    }
                </style>
            </head>
            <body>
                <a href="/login" class="login-btn">ä½¿ç”¨ NodeLoc ç™»å½•</a>
            </body>
        </html>
    '''

@app.route('/login')
def login():
    """å‘èµ·æˆæƒ"""
    redirect_uri = url_for('authorize', _external=True)
    return NodeLoc.authorize_redirect(redirect_uri)

@app.route('/authorize')
def authorize():
    """æˆæƒå›è°ƒ"""
    token = NodeLoc.authorize_access_token()
    
    # è·å–ç”¨æˆ·ä¿¡æ¯
    resp = NodeLoc.get('/oauth-provider/userinfo', token=token)
    user = resp.json()
    
    # ä¿å­˜åˆ° session
    session['user'] = user
    session['token'] = token
    
    return redirect('/')

@app.route('/logout')
def logout():
    """é€€å‡ºç™»å½•"""
    session.pop('user', None)
    session.pop('token', None)
    return redirect('/')

@app.route('/api/me')
def api_me():
    """API ç¤ºä¾‹ - è·å–å½“å‰ç”¨æˆ·"""
    user = session.get('user')
    
    if not user:
        return jsonify({'error': 'Not authenticated'}), 401
    
    return jsonify({
        'id': user['id'],
        'username': user['username'],
        'name': user['name'],
        'avatar_url': user['avatar_url'],
        'trust_level': user['trust_level']
    })

if __name__ == '__main__':
    # æ£€æŸ¥ç¯å¢ƒå˜é‡
    required_vars = ['NodeLoc_URL', 'NodeLoc_CLIENT_ID', 'NodeLoc_CLIENT_SECRET']
    missing_vars = [var for var in required_vars if not os.getenv(var)]
    
    if missing_vars:
        print(f"é”™è¯¯ï¼šç¼ºå°‘ç¯å¢ƒå˜é‡: {', '.join(missing_vars)}")
        exit(1)
    
    print("æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:5000")
    app.run(debug=True)
```

#### è¿è¡Œåº”ç”¨

```bash
export NodeLoc_URL=https://www.nodeloc.com.com
export NodeLoc_CLIENT_ID=your-client-id
export NodeLoc_CLIENT_SECRET=your-client-secret

python app.py
```

---

### Ruby on Rails + Devise

#### Gemfile

```ruby
gem 'devise'
gem 'omniauth'
gem 'omniauth-oauth2'
gem 'omniauth-rails_csrf_protection'
```

#### config/initializers/devise.rb

```ruby
Devise.setup do |config|
  config.omniauth :NodeLoc,
    ENV['NodeLoc_CLIENT_ID'],
    ENV['NodeLoc_CLIENT_SECRET'],
    {
      client_options: {
        site: ENV['NodeLoc_URL'],
        authorize_url: '/oauth-provider/authorize',
        token_url: '/oauth-provider/token'
      },
      scope: 'openid profile email'
    }
end
```

#### app/models/user.rb

```ruby
class User < ApplicationRecord
  devise :omniauthable, omniauth_providers: [:NodeLoc]
  
  def self.from_omniauth(auth)
    where(provider: auth.provider, uid: auth.uid).first_or_create do |user|
      user.email = auth.info.email || "#{auth.uid}@NodeLoc.local"
      user.username = auth.info.username
      user.name = auth.info.name
      user.avatar_url = auth.info.image
      user.password = Devise.friendly_token[0, 20]
    end
  end
end
```

#### app/controllers/users/omniauth_callbacks_controller.rb

```ruby
class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
  def NodeLoc
    @user = User.from_omniauth(request.env['omniauth.auth'])

    if @user.persisted?
      sign_in_and_redirect @user, event: :authentication
      set_flash_message(:notice, :success, kind: 'NodeLoc') if is_navigational_format?
    else
      session['devise.NodeLoc_data'] = request.env['omniauth.auth'].except(:extra)
      redirect_to new_user_registration_url
    end
  end

  def failure
    redirect_to root_path
  end
end
```

---

## â“ å¸¸è§é—®é¢˜

### 1. å¦‚ä½•å¤„ç† Token è¿‡æœŸï¼Ÿ

Access Token é»˜è®¤æœ‰æ•ˆæœŸä¸º 2 å°æ—¶ï¼ˆ7200 ç§’ï¼‰ã€‚è¿‡æœŸåéœ€è¦é‡æ–°æˆæƒï¼Œæˆ–ä½¿ç”¨ Refresh Tokenï¼ˆå¦‚æœæ”¯æŒï¼‰ã€‚

```javascript
// æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
function isTokenExpired(expiresAt) {
  return Date.now() >= expiresAt * 1000;
}

// ä½¿ç”¨ Refresh Token åˆ·æ–°
async function refreshAccessToken(refreshToken) {
  const response = await fetch(`${NodeLoc_URL}/oauth-provider/token`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({
      grant_type: 'refresh_token',
      refresh_token: refreshToken,
      client_id: CLIENT_ID,
      client_secret: CLIENT_SECRET
    })
  });
  
  return await response.json();
}
```

### 2. å¦‚ä½•å¤„ç†é”™è¯¯ï¼Ÿ

æ‰€æœ‰é”™è¯¯éƒ½ä¼šè¿”å›æ ‡å‡†çš„ OAuth 2.0 é”™è¯¯æ ¼å¼ï¼š

```json
{
  "error": "invalid_client",
  "error_description": "Invalid client credentials"
}
```

**å¸¸è§é”™è¯¯ä»£ç ï¼š**

| é”™è¯¯ä»£ç  | è¯´æ˜ | è§£å†³æ–¹æ³• |
|---------|------|---------|
| `invalid_request` | è¯·æ±‚å‚æ•°ç¼ºå¤±æˆ–æ— æ•ˆ | æ£€æŸ¥å¿…å¡«å‚æ•° |
| `invalid_client` | Client ID æˆ– Secret æ— æ•ˆ | éªŒè¯åº”ç”¨å‡­è¯ |
| `invalid_grant` | æˆæƒç æ— æ•ˆæˆ–å·²è¿‡æœŸ | é‡æ–°å‘èµ·æˆæƒ |
| `unauthorized_client` | å®¢æˆ·ç«¯æœªæˆæƒ | æ£€æŸ¥åº”ç”¨çŠ¶æ€ |
| `unsupported_grant_type` | ä¸æ”¯æŒçš„ Grant Type | ä½¿ç”¨ `authorization_code` |
| `invalid_token` | Access Token æ— æ•ˆ | é‡æ–°è·å– Token |

### 3. name å­—æ®µä¸ºç©ºæ€ä¹ˆåŠï¼Ÿ

å½“ç”¨æˆ·æ²¡æœ‰è®¾ç½®æ˜¾ç¤ºåç§°æ—¶ï¼Œ`name` å­—æ®µä¼šè‡ªåŠ¨ä½¿ç”¨ `username` çš„å€¼ã€‚æ‚¨ä¸éœ€è¦åšé¢å¤–å¤„ç†ã€‚

```javascript
// UserInfo å“åº”ç¤ºä¾‹ï¼ˆname ä¸ºç©ºæ—¶ï¼‰
{
  "id": 123,
  "username": "user1",
  "name": "user1",  // è‡ªåŠ¨ä½¿ç”¨ username
  "avatar_url": "...",
  "trust_level": 1
}
```

### 4. å¦‚ä½•æµ‹è¯• OAuth é›†æˆï¼Ÿ

ä½¿ç”¨ä»¥ä¸‹æµ‹è¯•è„šæœ¬å¿«é€ŸéªŒè¯ï¼š

```bash
# 1. åœ¨æµè§ˆå™¨ä¸­è®¿é—®æˆæƒ URL
https://www.nodeloc.com.com/oauth-provider/authorize?client_id=YOUR_ID&redirect_uri=http://your-url.com/callback&response_type=code&state=test

# 2. æˆæƒåè·å– codeï¼Œç„¶åäº¤æ¢ Token
curl -X POST https://www.nodeloc.com.com/oauth-provider/token \
  -d "grant_type=authorization_code" \
  -d "code=YOUR_CODE" \
  -d "redirect_uri=http://your-url.com/callback" \
  -d "client_id=YOUR_ID" \
  -d "client_secret=YOUR_SECRET"

# 3. ä½¿ç”¨ Token è·å–ç”¨æˆ·ä¿¡æ¯
curl -X GET https://www.nodeloc.com.com/oauth-provider/userinfo \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### 5. æ”¯æŒå“ªäº› Scopeï¼Ÿ

ç›®å‰æ”¯æŒä»¥ä¸‹ scopeï¼š
- `openid` - æ ‡å‡† OpenID Connect scopeï¼ˆ**å¿…éœ€ï¼Œä¸å¯å–æ¶ˆ**ï¼‰
- `profile` - ç”¨æˆ·èµ„æ–™ï¼ˆå¤´åƒã€ä¸ªäººç®€ä»‹ç­‰ï¼‰
- `email` - ç”¨æˆ·é‚®ç®±åœ°å€ï¼ˆ**éœ€è¦ç®¡ç†å‘˜å®¡æ ¸**ï¼‰

ç¤ºä¾‹ï¼š
```
scope=openid profile email
```

**é‡è¦æç¤ºï¼š** 
- `openid` scope æ˜¯å¿…éœ€çš„ï¼Œåˆ›å»ºåº”ç”¨æ—¶ä¼šè‡ªåŠ¨åŒ…å«ä¸”æ— æ³•å–æ¶ˆ
- å¦‚æœæ‚¨çš„åº”ç”¨ç”³è¯·äº† `email` scopeï¼Œåº”ç”¨åˆ›å»ºåéœ€è¦ç®¡ç†å‘˜å®¡æ ¸æ‰¹å‡†æ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚

### 6. åº”ç”¨å®¡æ ¸çŠ¶æ€è¯´æ˜

å½“æ‚¨çš„åº”ç”¨ç”³è¯·äº†éœ€è¦å®¡æ ¸çš„æƒé™ï¼ˆå¦‚ `email`ï¼‰æ—¶ï¼Œåº”ç”¨ä¼šå¤„äºä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€ï¼š

| çŠ¶æ€ | è¯´æ˜ | ç”¨æˆ·æ“ä½œ |
|------|------|----------|
| å¾…å®¡æ ¸ (Pending) | åº”ç”¨å·²åˆ›å»ºï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ | ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ |
| å·²æ‰¹å‡† (Approved) | åº”ç”¨å·²é€šè¿‡å®¡æ ¸ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ | å¯ä»¥æ­£å¸¸æˆæƒ |
| å·²æ‹’ç» (Rejected) | åº”ç”¨æœªé€šè¿‡å®¡æ ¸ | è”ç³»ç®¡ç†å‘˜æˆ–ä¿®æ”¹æƒé™é‡æ–°ç”³è¯· |

**å¦‚ä½•æŸ¥çœ‹å®¡æ ¸çŠ¶æ€ï¼š**
1. è®¿é—® `https://www.nodeloc.com.com/oauth-provider/applications`
2. åœ¨åº”ç”¨åˆ—è¡¨ä¸­æŸ¥çœ‹"å®¡æ ¸çŠ¶æ€"åˆ—
3. å¾…å®¡æ ¸çš„åº”ç”¨ä¼šæ˜¾ç¤ºé»„è‰²è­¦å‘Šå›¾æ ‡

**å®¡æ ¸è¢«æ‹’ç»çš„å¤„ç†ï¼š**
- è”ç³» NodeLoc ç®¡ç†å‘˜äº†è§£æ‹’ç»åŸå› 
- å¦‚æœä¸éœ€è¦ email æƒé™ï¼Œå¯ä»¥ç¼–è¾‘åº”ç”¨å¹¶ç§»é™¤è¯¥æƒé™
- ä¿®æ”¹åçš„åº”ç”¨å¦‚æœä¸åŒ…å«éœ€è¦å®¡æ ¸çš„æƒé™ï¼Œä¼šè‡ªåŠ¨å˜ä¸º"å·²æ‰¹å‡†"çŠ¶æ€

### 7. å¦‚ä½•ä¿æŠ¤ Client Secretï¼Ÿ

**é‡è¦å®‰å…¨æç¤ºï¼š**

- âœ… **æœåŠ¡ç«¯å­˜å‚¨**: å°† Client Secret å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ç¯å¢ƒå˜é‡ä¸­
- âœ… **HTTPS é€šä¿¡**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- âœ… **å®šæœŸæ›´æ¢**: å®šæœŸåœ¨ NodeLoc ä¸­é‡æ–°ç”Ÿæˆ Client Secret
- âŒ **ä¸è¦æš´éœ²**: æ°¸è¿œä¸è¦å°† Secret æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶æˆ–å‰ç«¯ä»£ç ä¸­
- âŒ **ä¸è¦è®°å½•**: ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•å®Œæ•´çš„ Secret

### 8. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] ä½¿ç”¨ HTTPS åè®®
- [ ] é…ç½®æ­£ç¡®çš„ Redirect URI
- [ ] ç¯å¢ƒå˜é‡å®‰å…¨å­˜å‚¨
- [ ] å®ç°é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- [ ] æ·»åŠ  State å‚æ•°é˜²æ­¢ CSRF
- [ ] å®ç° Token åˆ·æ–°æœºåˆ¶
- [ ] é…ç½®ä¼šè¯è¶…æ—¶
- [ ] æ·»åŠ ç”¨æˆ·é€€å‡ºç™»å½•åŠŸèƒ½
- [ ] æµ‹è¯•å®Œæ•´çš„æˆæƒæµç¨‹